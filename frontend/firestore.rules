rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function authRole() {
      return request.auth != null && request.auth.token.role is string
        ? lower(request.auth.token.role)
        : null;
    }

    function isAdmin() {
      return authRole() == 'admin';
    }

    function isTeacher() {
      return authRole() == 'teacher';
    }

    function isStudent() {
      return authRole() == 'student';
    }

    function staffCanAccess() {
      return isSignedIn() && (isAdmin() || isTeacher());
    }

    function lowerAuthEmail() {
      return request.auth != null && request.auth.token.email != null
        ? lower(request.auth.token.email)
        : null;
    }

    function hasNotificationAccess(resourceData) {
      let targets = resourceData.targets;
      return targets is list && (
        (request.auth != null && request.auth.uid in targets) ||
        (lowerAuthEmail() != null && lowerAuthEmail() in targets)
      );
    }

    function hasUserIdForRole(userId, role) {
      return role == 'admin' && userId.matches('^A[0-9]+$')
        || role == 'teacher' && userId.matches('^T[0-9]+$')
        || role == 'student' && userId.matches('^S[0-9]+$');
    }

    function requestEmailMatches(resourceData) {
      return request.auth != null && resourceData.email is string
        && lower(resourceData.email) == lowerAuthEmail();
    }

    function attendanceStudentId(resourceData) {
      return resourceData.studentID is string
        ? resourceData.studentID
        : resourceData.studentId;
    }

    function matchesAuthStudentId(studentId) {
      return isSignedIn()
        && studentId is string
        && (
          studentId == request.auth.uid
            || (request.auth.token.studentID is string && studentId == request.auth.token.studentID)
            || (request.auth.token.studentId is string && studentId == request.auth.token.studentId)
        );
    }

    function linkedUserRecordMatchesAuthUser(resourceData) {
      let studentId = attendanceStudentId(resourceData);
      let userDoc = studentId is string
        ? get(/databases/$(database)/documents/users/$(studentId))
        : null;

      return userDoc != null && userDoc.exists()
        && (
          requestEmailMatches(userDoc.data)
            || matchesAuthStudentId(userDoc.data.studentID)
            || matchesAuthStudentId(userDoc.data.userId)
        );
    }

    match /users/{userId} {
      allow get, list: if staffCanAccess() || (isStudent() && requestEmailMatches(resource.data));

      allow create: if staffCanAccess()
        && request.resource.data.role is string
        && hasUserIdForRole(userId, lower(request.resource.data.role));

      allow update, delete: if staffCanAccess()
        && resource.data.role is string
        && hasUserIdForRole(userId, lower(resource.data.role));
    }

    match /classes/{classId} {
      allow read, write: if staffCanAccess();

      allow get, list: if isStudent() && isSignedIn();
    }

    match /attendance/{attendanceId} {
      allow read, write: if staffCanAccess();

      allow get, list: if isStudent() && isSignedIn()
        && (
          matchesAuthStudentId(attendanceStudentId(resource.data))
            || requestEmailMatches(resource.data)
            || linkedUserRecordMatchesAuthUser(resource.data)
        );
    }

    match /notifications/{notificationId} {
      allow get, list: if isSignedIn() && hasNotificationAccess(resource.data);

      allow update: if isSignedIn() && hasNotificationAccess(resource.data)
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.type == resource.data.type
        && request.resource.data.channel == resource.data.channel
        && request.resource.data.surfaceTargets == resource.data.surfaceTargets
        && request.resource.data.dedupeKey == resource.data.dedupeKey
        && request.resource.data.targets == resource.data.targets
        && request.resource.data.payload == resource.data.payload
        && request.resource.data.title == resource.data.title
        && request.resource.data.message == resource.data.message
        && request.resource.data.tone == resource.data.tone
        && request.resource.data.actionLabel == resource.data.actionLabel
        && request.resource.data.actionHref == resource.data.actionHref
        && request.resource.data.toast == resource.data.toast
        && request.resource.data.banner == resource.data.banner
        && request.resource.data.userEmail == resource.data.userEmail
        && request.resource.data.read is bool
        && request.resource.data.updatedAt is timestamp
        && (!('dismissedSurfaces' in request.resource.data) || request.resource.data.dismissedSurfaces is map)
        && (!('acknowledgedAt' in request.resource.data) || request.resource.data.acknowledgedAt is timestamp);

      allow create, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
