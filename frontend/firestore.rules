rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function lowerAuthEmail() {
      return request.auth != null && request.auth.token.email != null
        ? lower(request.auth.token.email)
        : null;
    }

    function userDocument() {
      if (!isSignedIn()) {
        return null;
      }

      let uidDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (uidDoc != null && uidDoc.data != null) {
        return uidDoc.data;
      }

      let authEmail = lowerAuthEmail();
      if (authEmail == null) {
        return null;
      }

      let emailDoc = get(/databases/$(database)/documents/users/$(authEmail));
      return emailDoc != null ? emailDoc.data : null;
    }

    function authRole() {
      let userDoc = userDocument();
      return userDoc != null && userDoc.role is string
        ? lower(userDoc.role)
        : null;
    }

    function isAdmin() {
      return authRole() == 'admin';
    }

    function isTeacher() {
      return authRole() == 'teacher';
    }

    function isStudent() {
      return authRole() == 'student';
    }

    function staffCanAccess() {
      return isSignedIn() && (isAdmin() || isTeacher());
    }

    function hasNotificationAccess(resourceData) {
      let targets = resourceData.targets;
      return targets is list && (
        (request.auth != null && request.auth.uid in targets) ||
        (lowerAuthEmail() != null && lowerAuthEmail() in targets)
      );
    }

    function hasUserIdForRole(userId, role) {
      return role == 'admin' && userId.matches('^A[0-9]+$')
        || role == 'teacher' && userId.matches('^T[0-9]+$')
        || role == 'student' && userId.matches('^S[0-9]+$');
    }

    function requestEmailMatches(resourceData) {
      return request.auth != null && resourceData.email is string
        && lower(resourceData.email) == lowerAuthEmail();
    }

    match /users/{userId} {
      allow get, list: if staffCanAccess() || (isStudent() && requestEmailMatches(resource.data));

      allow create: if staffCanAccess()
        && request.resource.data.role is string
        && hasUserIdForRole(userId, lower(request.resource.data.role));

      allow update, delete: if staffCanAccess()
        && resource.data.role is string
        && hasUserIdForRole(userId, lower(resource.data.role));
    }

    match /classes/{classId} {
      allow read, write: if staffCanAccess();

      allow get, list: if isStudent() && isSignedIn();
    }

    match /attendance/{attendanceId} {
      allow read, write: if staffCanAccess();

      allow get, list: if isStudent() && isSignedIn()
        && ((resource.data.studentID != null && resource.data.studentID == request.auth.uid)
          || (resource.data.studentId != null && resource.data.studentId == request.auth.uid)
          || requestEmailMatches(resource.data));
    }

    match /notifications/{notificationId} {
      allow get, list: if isSignedIn() && hasNotificationAccess(resource.data);

      allow update: if isSignedIn() && hasNotificationAccess(resource.data)
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.type == resource.data.type
        && request.resource.data.channel == resource.data.channel
        && request.resource.data.surfaceTargets == resource.data.surfaceTargets
        && request.resource.data.dedupeKey == resource.data.dedupeKey
        && request.resource.data.targets == resource.data.targets
        && request.resource.data.payload == resource.data.payload
        && request.resource.data.title == resource.data.title
        && request.resource.data.message == resource.data.message
        && request.resource.data.tone == resource.data.tone
        && request.resource.data.actionLabel == resource.data.actionLabel
        && request.resource.data.actionHref == resource.data.actionHref
        && request.resource.data.toast == resource.data.toast
        && request.resource.data.banner == resource.data.banner
        && request.resource.data.userEmail == resource.data.userEmail
        && request.resource.data.read is bool
        && request.resource.data.updatedAt is timestamp
        && (!('dismissedSurfaces' in request.resource.data) || request.resource.data.dismissedSurfaces is map)
        && (!('acknowledgedAt' in request.resource.data) || request.resource.data.acknowledgedAt is timestamp);

      allow create, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
